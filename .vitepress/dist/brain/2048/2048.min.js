(function(){var r=0;var e=["webkit","moz"];for(var t=0;t<e.length&&!window.requestAnimationFrame;++t){window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"]||window[e[t]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(e){var t=(new Date).getTime();var i=Math.max(0,16-(t-r));var n=window.setTimeout(function(){e(t+i)},i);r=t+i;return n}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(e){clearTimeout(e)}}})();window.requestAnimationFrame(function(){new GameManager(4,KeyboardInputManager,HTMLActuator,LocalStorageManager)});Function.prototype.bind=Function.prototype.bind||function(t){var i=this;return function(e){if(!(e instanceof Array)){e=[e]}i.apply(t,e)}};(function(){if(typeof window.Element==="undefined"||"classList"in document.documentElement){return}var e=Array.prototype,n=e.push,i=e.splice,t=e.join;function r(e){this.el=e;var t=e.className.replace(/^\s+|\s+$/g,"").split(/\s+/);for(var i=0;i<t.length;i++){n.call(this,t[i])}}r.prototype={add:function(e){if(this.contains(e))return;n.call(this,e);this.el.className=this.toString()},contains:function(e){return this.el.className.indexOf(e)!=-1},item:function(e){return this[e]||null},remove:function(e){if(!this.contains(e))return;for(var t=0;t<this.length;t++){if(this[t]==e)break}i.call(this,t,1);this.el.className=this.toString()},toString:function(){return t.call(this," ")},toggle:function(e){if(!this.contains(e)){this.add(e)}else{this.remove(e)}return this.contains(e)}};window.DOMTokenList=r;function a(e,t,i){if(Object.defineProperty){Object.defineProperty(e,t,{get:i})}else{e.__defineGetter__(t,i)}}a(HTMLElement.prototype,"classList",function(){return new r(this)})})();function GameManager(e,t,i,n){this.size=e;this.inputManager=new t;this.storageManager=new n;this.actuator=new i;this.startTiles=2;this.inputManager.on("move",this.move.bind(this));this.inputManager.on("restart",this.restart.bind(this));this.inputManager.on("keepPlaying",this.keepPlaying.bind(this));this.setup()}GameManager.prototype.restart=function(){this.storageManager.clearGameState();this.actuator.continueGame();this.setup()};GameManager.prototype.keepPlaying=function(){this.keepPlaying=true;this.actuator.continueGame()};GameManager.prototype.isGameTerminated=function(){return this.over||this.won&&!this.keepPlaying};GameManager.prototype.setup=function(){var e=this.storageManager.getGameState();if(e){this.grid=new Grid(e.grid.size,e.grid.cells);this.score=e.score;this.over=e.over;this.won=e.won;this.keepPlaying=e.keepPlaying}else{this.grid=new Grid(this.size);this.score=0;this.over=false;this.won=false;this.keepPlaying=false;this.addStartTiles()}this.actuate()};GameManager.prototype.addStartTiles=function(){for(var e=0;e<this.startTiles;e++){this.addRandomTile()}};GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var e=Math.random()<.9?2:4;var t=new Tile(this.grid.randomAvailableCell(),e);this.grid.insertTile(t)}};GameManager.prototype.actuate=function(){if(this.storageManager.getBestScore()<this.score){this.storageManager.setBestScore(this.score)}if(this.over){this.storageManager.clearGameState()}else{this.storageManager.setGameState(this.serialize())}this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.storageManager.getBestScore(),terminated:this.isGameTerminated()})};GameManager.prototype.serialize=function(){return{grid:this.grid.serialize(),score:this.score,over:this.over,won:this.won,keepPlaying:this.keepPlaying}};GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(e,t,i){if(i){i.mergedFrom=null;i.savePosition()}})};GameManager.prototype.moveTile=function(e,t){this.grid.cells[e.x][e.y]=null;this.grid.cells[t.x][t.y]=e;e.updatePosition(t)};GameManager.prototype.move=function(e){var a=this;if(this.isGameTerminated())return;var o,s;var l=this.getVector(e);var t=this.buildTraversals(l);var c=false;this.prepareTiles();t.x.forEach(function(r){t.y.forEach(function(e){o={x:r,y:e};s=a.grid.cellContent(o);if(s){var t=a.findFarthestPosition(o,l);var i=a.grid.cellContent(t.next);if(i&&i.value===s.value&&!i.mergedFrom){var n=new Tile(t.next,s.value*2);n.mergedFrom=[s,i];a.grid.insertTile(n);a.grid.removeTile(s);s.updatePosition(t.next);a.score+=n.value;if(n.value===2048)a.won=true}else{a.moveTile(s,t.farthest)}if(!a.positionsEqual(o,s)){c=true}}})});if(c){this.addRandomTile();if(!this.movesAvailable()){this.over=true}this.actuate()}};GameManager.prototype.getVector=function(e){var t={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};return t[e]};GameManager.prototype.buildTraversals=function(e){var t={x:[],y:[]};for(var i=0;i<this.size;i++){t.x.push(i);t.y.push(i)}if(e.x===1)t.x=t.x.reverse();if(e.y===1)t.y=t.y.reverse();return t};GameManager.prototype.findFarthestPosition=function(e,t){var i;do{i=e;e={x:i.x+t.x,y:i.y+t.y}}while(this.grid.withinBounds(e)&&this.grid.cellAvailable(e));return{farthest:i,next:e}};GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()};GameManager.prototype.tileMatchesAvailable=function(){var e=this;var t;for(var i=0;i<this.size;i++){for(var n=0;n<this.size;n++){t=this.grid.cellContent({x:i,y:n});if(t){for(var r=0;r<4;r++){var a=e.getVector(r);var o={x:i+a.x,y:n+a.y};var s=e.grid.cellContent(o);if(s&&s.value===t.value){return true}}}}}return false};GameManager.prototype.positionsEqual=function(e,t){return e.x===t.x&&e.y===t.y};function Grid(e,t){this.size=e;this.cells=t?this.fromState(t):this.empty()}Grid.prototype.empty=function(){var e=[];for(var t=0;t<this.size;t++){var i=e[t]=[];for(var n=0;n<this.size;n++){i.push(null)}}return e};Grid.prototype.fromState=function(e){var t=[];for(var i=0;i<this.size;i++){var n=t[i]=[];for(var r=0;r<this.size;r++){var a=e[i][r];n.push(a?new Tile(a.position,a.value):null)}}return t};Grid.prototype.randomAvailableCell=function(){var e=this.availableCells();if(e.length){return e[Math.floor(Math.random()*e.length)]}};Grid.prototype.availableCells=function(){var n=[];this.eachCell(function(e,t,i){if(!i){n.push({x:e,y:t})}});return n};Grid.prototype.eachCell=function(e){for(var t=0;t<this.size;t++){for(var i=0;i<this.size;i++){e(t,i,this.cells[t][i])}}};Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length};Grid.prototype.cellAvailable=function(e){return!this.cellOccupied(e)};Grid.prototype.cellOccupied=function(e){return!!this.cellContent(e)};Grid.prototype.cellContent=function(e){if(this.withinBounds(e)){return this.cells[e.x][e.y]}else{return null}};Grid.prototype.insertTile=function(e){this.cells[e.x][e.y]=e};Grid.prototype.removeTile=function(e){this.cells[e.x][e.y]=null};Grid.prototype.withinBounds=function(e){return e.x>=0&&e.x<this.size&&e.y>=0&&e.y<this.size};Grid.prototype.serialize=function(){var e=[];for(var t=0;t<this.size;t++){var i=e[t]=[];for(var n=0;n<this.size;n++){i.push(this.cells[t][n]?this.cells[t][n].serialize():null)}}return{size:this.size,cells:e}};function HTMLActuator(){this.tileContainer=document.querySelector(".tile-container");this.scoreContainer=document.querySelector(".score-container");this.bestContainer=document.querySelector(".best-container");this.messageContainer=document.querySelector(".game-message");this.score=0}HTMLActuator.prototype.actuate=function(e,t){var i=this;window.requestAnimationFrame(function(){i.clearContainer(i.tileContainer);e.cells.forEach(function(e){e.forEach(function(e){if(e){i.addTile(e)}})});i.updateScore(t.score);i.updateBestScore(t.bestScore);if(t.terminated){if(t.over){i.message(false)}else if(t.won){i.message(true)}}})};HTMLActuator.prototype.continueGame=function(){this.clearMessage()};HTMLActuator.prototype.clearContainer=function(e){while(e.firstChild){e.removeChild(e.firstChild)}};HTMLActuator.prototype.addTile=function(e){var t=this;var i=document.createElement("div");var n=document.createElement("div");var r=e.previousPosition||{x:e.x,y:e.y};var a=this.positionClass(r);var o=["tile","tile-"+e.value,a];if(e.value>2048)o.push("tile-super");this.applyClasses(i,o);n.classList.add("tile-inner");n.textContent=e.value;if(e.previousPosition){window.requestAnimationFrame(function(){o[2]=t.positionClass({x:e.x,y:e.y});t.applyClasses(i,o)})}else if(e.mergedFrom){o.push("tile-merged");this.applyClasses(i,o);e.mergedFrom.forEach(function(e){t.addTile(e)})}else{o.push("tile-new");this.applyClasses(i,o)}i.appendChild(n);this.tileContainer.appendChild(i)};HTMLActuator.prototype.applyClasses=function(e,t){e.setAttribute("class",t.join(" "))};HTMLActuator.prototype.normalizePosition=function(e){return{x:e.x+1,y:e.y+1}};HTMLActuator.prototype.positionClass=function(e){e=this.normalizePosition(e);return"tile-position-"+e.x+"-"+e.y};HTMLActuator.prototype.updateScore=function(e){this.clearContainer(this.scoreContainer);var t=e-this.score;this.score=e;this.scoreContainer.textContent=this.score;if(t>0){var i=document.createElement("div");i.classList.add("score-addition");i.textContent="+"+t;this.scoreContainer.appendChild(i)}};HTMLActuator.prototype.updateBestScore=function(e){this.bestContainer.textContent=e};HTMLActuator.prototype.message=function(e){var t=e?"game-won":"game-over";var i=e?"You win!":"Game over!";this.messageContainer.classList.add(t);this.messageContainer.getElementsByTagName("p")[0].textContent=i};HTMLActuator.prototype.clearMessage=function(){this.messageContainer.classList.remove("game-won");this.messageContainer.classList.remove("game-over")};function KeyboardInputManager(){this.events={};if(window.navigator.msPointerEnabled){this.eventTouchstart="MSPointerDown";this.eventTouchmove="MSPointerMove";this.eventTouchend="MSPointerUp"}else{this.eventTouchstart="touchstart";this.eventTouchmove="touchmove";this.eventTouchend="touchend"}this.listen()}KeyboardInputManager.prototype.on=function(e,t){if(!this.events[e]){this.events[e]=[]}this.events[e].push(t)};KeyboardInputManager.prototype.emit=function(e,t){var i=this.events[e];if(i){i.forEach(function(e){e(t)})}};KeyboardInputManager.prototype.listen=function(){var s=this;var n={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3};document.addEventListener("keydown",function(e){var t=e.altKey||e.ctrlKey||e.metaKey||e.shiftKey;var i=n[e.which];if(!t){if(i!==undefined){e.preventDefault();s.emit("move",i)}}if(!t&&e.which===82){s.restart.call(s,e)}});this.bindButtonPress(".retry-button",this.restart);this.bindButtonPress(".restart-button",this.restart);this.bindButtonPress(".keep-playing-button",this.keepPlaying);var l,c;var e=document.getElementsByClassName("game-container")[0];e.addEventListener(this.eventTouchstart,function(e){if(!window.navigator.msPointerEnabled&&e.touches.length>1||e.targetTouches.length>1){return}if(window.navigator.msPointerEnabled){l=e.pageX;c=e.pageY}else{l=e.touches[0].clientX;c=e.touches[0].clientY}e.preventDefault()});e.addEventListener(this.eventTouchmove,function(e){e.preventDefault()});e.addEventListener(this.eventTouchend,function(e){if(!window.navigator.msPointerEnabled&&e.touches.length>0||e.targetTouches.length>0){return}var t,i;if(window.navigator.msPointerEnabled){t=e.pageX;i=e.pageY}else{t=e.changedTouches[0].clientX;i=e.changedTouches[0].clientY}var n=t-l;var r=Math.abs(n);var a=i-c;var o=Math.abs(a);if(Math.max(r,o)>10){s.emit("move",r>o?n>0?1:3:a>0?2:0)}})};KeyboardInputManager.prototype.restart=function(e){e.preventDefault();this.emit("restart")};KeyboardInputManager.prototype.keepPlaying=function(e){e.preventDefault();this.emit("keepPlaying")};KeyboardInputManager.prototype.bindButtonPress=function(e,t){var i=document.querySelector(e);i.addEventListener("click",t.bind(this));i.addEventListener(this.eventTouchend,t.bind(this))};window.fakeStorage={_data:{},setItem:function(e,t){return this._data[e]=String(t)},getItem:function(e){return this._data.hasOwnProperty(e)?this._data[e]:undefined},removeItem:function(e){return delete this._data[e]},clear:function(){return this._data={}}};function LocalStorageManager(){this.bestScoreKey="bestScore";this.gameStateKey="gameState";var e=this.localStorageSupported();this.storage=e?window.localStorage:window.fakeStorage}LocalStorageManager.prototype.localStorageSupported=function(){var e="test";try{var t=window.localStorage;t.setItem(e,"1");t.removeItem(e);return true}catch(e){return false}};LocalStorageManager.prototype.getBestScore=function(){return this.storage.getItem(this.bestScoreKey)||0};LocalStorageManager.prototype.setBestScore=function(e){this.storage.setItem(this.bestScoreKey,e)};LocalStorageManager.prototype.getGameState=function(){var e=this.storage.getItem(this.gameStateKey);return e?JSON.parse(e):null};LocalStorageManager.prototype.setGameState=function(e){this.storage.setItem(this.gameStateKey,JSON.stringify(e))};LocalStorageManager.prototype.clearGameState=function(){this.storage.removeItem(this.gameStateKey)};function Tile(e,t){this.x=e.x;this.y=e.y;this.value=t||2;this.previousPosition=null;this.mergedFrom=null}Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}};Tile.prototype.updatePosition=function(e){this.x=e.x;this.y=e.y};Tile.prototype.serialize=function(){return{position:{x:this.x,y:this.y},value:this.value}};